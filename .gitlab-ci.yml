include:
  - 'https://gitlab.com/accessable-net/gitlab-ci-templates/-/raw/master/scheduled_rebase.yml'

variables:
  UPSTREAM_BRANCH: gh-pages

.base:
  # requiring the environment of Ruby
  image: ruby:alpine
  before_script:
    - apk add build-base perl

    - find . -not \( -name .svn -prune -o -name .git -prune -o -name vendor \)
      -type f -print0 | xargs -0 sed -i 's/Island/Insular/g'
    - find . -not \( -name .svn -prune -o -name .git -prune -o -name vendor \)
      -type f -print0 |xargs -0 perl -pi -e
      's/com.oasisfeng.island(?=[^.])/com.oasisfeng.island.fdroid/g'

    - bundle config set path 'vendor/bundle'
    - bundle install
  # add cache to 'vendor' for speeding up builds
  cache:
    paths:
      - vendor/

# add a job called 'test'
test:
  extends: .base
  stage: test
  script:
    - bundle exec jekyll build -d test/
  artifacts:
    paths:
      - test # generating site folder to be browsed or download
  only:
    - gitlab-pages # this job will affect only the 'master' branch

# the 'pages' job will deploy and build your site to the 'public' path
pages:
  extends: .base
  stage: deploy
  variables:
    JEKYLL_ENV: production
  script:
    - bundle exec jekyll build -d public/ --incremental
  artifacts:
    paths:
      - public
  only:
    - gitlab-pages # this job will affect only the 'master' branch
